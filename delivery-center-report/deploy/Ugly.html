<!DOCTYPE html>
<html>
<head>
    <title>deliverycenterreport</title>
    <!--  (c) 2013 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Sun Feb 02 2014 19:27:37 GMT-0800 (PST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Sun Feb 02 2014 19:27:37 GMT-0800 (PST)";
        var CHECKSUM = [%= checksum %];
    </script>
    
    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            function addIterationTimeBox(a){var b=a.getContext().getTimeboxScope();if(b){var c=b.getRecord(),d=c.get("Name");a.iterationSelected(d)}else{var e=Ext.create("Ext.container.Container",{itemId:"iterationDropDown",columnWidth:2});a.add(e),a.down("#iterationDropDown").add({xtype:"rallyiterationcombobox",itemId:"iterationSelector",listeners:{select:function(a,b){this.iterationSelected(b[0].get("Name"))},scope:a}})}}function getIterations(a){Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,model:"Iteration",context:{project:null},listeners:{load:function(a,b){this.leafNodeProjectIterations(b)},scope:a},fetch:["Name","Project","ObjectID","PlannedVelocity","StartDate","EndDate"]})}Ext.define("Rally.technicalservices.InfoLink",{extend:"Ext.Component",alias:"widget.tsinfolink",informationHtml:null,text:"Information",renderTpl:"<div id='{id}-infolinkWrap' class='tsinfolink'>TS</div>",initComponent:function(){this.callParent(arguments)},onRender:function(){this.callParent(arguments),this.mon(this.el,"click",this.onClick,this)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(){var a=this;Ext.Ajax.request({url:document.URL,params:{id:1},success:function(b){text=b.responseText,CHECKSUM&&CHECKSUM!==a._generateChecksum(text)&&(console.log("Checksums don't match!"),a.dialog&&a.dialog.add({xtype:"container",html:"Checksums do not match"}))}})},onClick:function(){var a=this;this._checkChecksum(this);var b=[];this.informationHtml&&b.push({xtype:"container",html:this.informationHtml}),b.push({xtype:"container",html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&b.push({xtype:"container",html:"Build date/time: "+APP_BUILD_DATE}),this.dialog&&this.dialog.destroy(),this.dialog=Ext.create("Rally.ui.dialog.Dialog",{defaults:{padding:5,margin:5},closable:!0,draggable:!0,title:a.title,items:b}),this.dialog.show()}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(){var a="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",b=[];b=Ext.Array.push(b,[a]),b=Ext.Array.push(b,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,b)}});var FIELD_DELIVERY_SATISFACTION="Deliverysatisfactionscore110",FIELD_REMARKS="c_Managementinformationrequest",FIELD_STATUS="Teamstatus",FIELD_LPC_VELOCITY="LPCVelocity",FIELD_TEAM_LIFECYCLE="TeamLifecycle",TEAM_LIFECYCLE_TO_HIDE=["Temporary","Not Started","Inactive"],THRESHOLD_VELOCITY=80,THRESHOLD_SATISFACTION=7;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,title:"Delivery Center Status Report",version:"0.50",launch:function(){this.logger.log("launch"),this.rows=[],this.showTable(),getIterations(this)},_toDate:function(a){return new Date(Date.parse(a))},leafNodeProjectIterations:function(a){var b=this,c=_.pluck(a,function(a){return a.get("Project").ObjectID});c=_.uniq(c),async.map(c,b.readProject,function(c,d){a=_.filter(a,function(a){var b=_.find(d,function(b){return b.get("ObjectID")==a.get("Project").ObjectID});return null==b.get("Children")||0==b.get("Children").Count}),b.processIterations(a)})},processIterations:function(a){var b=this,c=new Date,d=_.groupBy(a,function(a){var b=a.get("Project"),c=b.Name;return c}),e=_.keys(d);e=_.sortBy(e,function(a){return a}),this.logger.log("keys",e),_.each(e,function(a){var e=d[a];e=_.filter(e,function(a){var d=b._toDate(a.get("EndDate"));return c>d}),e=_.sortBy(e,function(a){return b._toDate(a.get("EndDate"))}),e=e.length<=3?e:e.slice(-3),e=e.reverse();_.pluck(e,function(a){return a.get("ObjectID")});async.map(e,b.getIterationWorkItems,function(c,d){async.map(e,b.getSpecialStory,function(c,f){b.processWorkItems(a,e,d,f)})})})},getSpecialStory:function(a,b){var c=this;Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,model:"HierarchicalRequirement",filters:[{property:"Iteration.ObjectID",operator:"=",value:a.get("ObjectID")},{property:"Parent.Name",operator:"contains",value:"Iteration Reporting Parent"}],listeners:{load:function(a,c){b(null,c)},scope:c},sorters:[{property:"CreationDate",direction:"ASC"}],fetch:["FormattedID","Name","PlanEstimate","ScheduleState","CreationDate",FIELD_DELIVERY_SATISFACTION,FIELD_REMARKS,FIELD_STATUS,FIELD_LPC_VELOCITY,FIELD_TEAM_LIFECYCLE]})},getIterationWorkItems:function(a,b){Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,model:"UserStory",filters:[{property:"Iteration.ObjectID",operator:"=",value:a.get("ObjectID")}],listeners:{load:function(c,d){Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,model:"Defect",filters:[{property:"Iteration.ObjectID",operator:"=",value:a.get("ObjectID")}],listeners:{load:function(a,c){var e=Ext.Array.push(d,c);b(null,e)},scope:this}})},scope:this}})},readProject:function(a,b){Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,fetch:!0,model:"Project",filters:[{property:"ObjectID",operator:"=",value:a}],listeners:{load:function(a,c){b(null,c[0])},scope:this}})},getIterationResults:function(a,b){var c=this;Ext.create("Rally.data.WsapiDataStore",{limit:"Infinity",autoLoad:!0,model:"IterationCumulativeFlowData",filters:[{property:"IterationObjectID",operator:"=",value:a.get("ObjectID")}],listeners:{load:function(a,c){b(null,c)},scope:c},sorters:[{property:"CreationDate",direction:"ASC"}],fetch:["IterationObjectID","CardCount","CardEstimateTotal","CardState","CreationDate"]})},sumCFDForState:function(a,b){var c="*"==b?a:_.filter(a,function(a){return a.get("CardState")==b}),d=_.reduce(c,function(a,b){return a+b.get("CardEstimateTotal")},0);return d},sumWIForState:function(a,b){var c="*"==b?a:_.filter(a,function(a){return a.get("ScheduleState")==b}),d=_.reduce(c,function(a,b){return a+b.get("PlanEstimate")},0);return d},countWIForState:function(a,b){var c="*"==b?a:_.filter(a,function(a){return a.get("ScheduleState")==b}),d=c.length;return d},countCFDForState:function(a,b){var c="*"==b?a:_.filter(a,function(a){return a.get("ScheduleState")==b}),d=_.reduce(c,function(b){return b+a.get("CardEstimateTotal")},0);return d},processWorkItems:function(a,b,c,d){var e=this;_.each(b,function(b,f){var g=c[f],h=null!==d[f]&&d[f].length>0?d[f][0]:null,i=null!==h?h.get(FIELD_TEAM_LIFECYCLE):"";if(e.logger.log("specialStory: ",h),e.logger.log("teamLifecycle: ",i),-1==TEAM_LIFECYCLE_TO_HIDE.indexOf(i)){var j=e.sumWIForState(g,"Accepted"),k=(j+e.sumWIForState(g,"Completed"),e.sumWIForState(g,"Backlog"),e.sumWIForState(g,"Defined"),e.sumWIForState(g,"In-Progress"),e.countWIForState(g,"*"),e.countWIForState(g,"Accepted")),l=k+e.countWIForState(g,"Completed"),m=null!==h?h.get(FIELD_LPC_VELOCITY):0,n=null!=b.get("PlannedVelocity")?b.get("PlannedVelocity"):0,o=m>0?Math.round(n/m*100):0,p=n>0?Math.round(j/n*100):0,q={team:a,iteration:b.get("Name"),enddate:b.get("EndDate"),lpcVelocity:m,completedCount:l,plannedVelocity:n,acceptedCount:k,targetUtilization:o,deliverySatisfaction:null!==h?h.get(FIELD_DELIVERY_SATISFACTION):"",remarks:null!==h?h.get(FIELD_REMARKS):"",status:null!==h?h.get(FIELD_STATUS):"",accepted:j,velocityUtilization:p};e.rows.push(q),e.store.load(),e.store.sort([{property:"team",direction:"ASC"},{property:"enddate",direction:"DESC"}])}})},showTable:function(){var a=this,b=500;this.store=Ext.create("Rally.data.custom.Store",{fields:[{name:"team",type:"string"},{name:"iteration",type:"string"},{name:"enddate",type:"date"},{name:"lpcVelocity",type:"number"},{name:"completedCount",type:"number"},{name:"plannedVelocity",type:"number"},{name:"acceptedCount",type:"number"},{name:"targetUtilization",type:"number"},{name:"deliverySatisfaction",type:"string"},{name:"remarks",type:"string"},{name:"status",type:"string"},{name:"accepted",type:"number"},{name:"velocityUtilization",type:"number"}],data:this.rows}),this.grid=Ext.create("Rally.ui.grid.Grid",{store:this.store,height:b,columnCfgs:[{text:"Team",dataIndex:"team"},{text:"Iteration",dataIndex:"iteration",flex:1.1},{text:"End Date",dataIndex:"enddate",flex:1.1,renderer:Ext.util.Format.dateRenderer()},{text:"LPC Velocity",dataIndex:"lpcVelocity",align:"center"},{text:"Target Velocity",dataIndex:"plannedVelocity",align:"center"},{text:"Accepted Points",dataIndex:"accepted",align:"center"},{text:"Target <br/>Utilization (%)",dataIndex:"targetUtilization",align:"center",renderer:this.renderVelocity},{text:"Velocity (%)",dataIndex:"velocityUtilization",align:"center",renderer:this.renderVelocity},{text:"Delivery Satisfaction",dataIndex:"deliverySatisfaction",align:"center",renderer:this.renderSatisfaction},{text:"Management information/request",dataIndex:"remarks",align:"center",tdCls:"wrap",flex:1},{text:"Status",dataIndex:"status",align:"center",renderer:this.renderStatus}],listeners:{afterrender:function(b){b.setHeight(a.getHeight()-20)}}}),this.add(this.grid)},renderVelocity:function(a,b){return THRESHOLD_VELOCITY>a?(b.style="background-color:red;color:white;",a):(b.style="background-color:green;color:white;",a)},renderStatus:function(a,b){return"Green"==a?(b.style="background-color:green;color:white;",a):"Red"==a?(b.style="background-color:red;color:white",a):"Yellow"==a?(b.style="background-color:yellow",a):void 0},renderSatisfaction:function(a,b){return a>=1&&THRESHOLD_SATISFACTION>=a?(b.style="background-color:red;color:white;",a):a>THRESHOLD_SATISFACTION?(b.style="background-color:green;color:white",a):void 0}});
            
               Rally.launchApp('CustomApp', {
                   name: 'deliverycenterreport'
               });
        });
    </script>
    
    <style type="text/css">

.app {
     /* Add app styles here */
}

.wrap .x-grid-cell-inner {
    white-space: normal;
}

.red {
    background-color : red;
}

.green {
    background-color : green;
}
    </style>

</head>
<body></body>
</html>